<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Revis√µes & Manuten√ß√µes - Motorista App</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
    --bg:#ffffff;
    --page-gap:#f3f5f8;
    --card:#fafbfc;
    --card-strong:#f0f2f5;
    --panel:#ffffff;
    --brand:#0b5bd7;
    --brand-dark:#073f8a;
    --accent-success:#1DB954;
    --accent-danger:#ff3b30;
    --text:#0b1115;
    --muted:#65707a;
    --shadow:0 6px 16px rgba(13,30,45,.07);
    --shadow-strong:0 10px 32px rgba(10,20,30,.12);
    --radius:14px;
}

.dark{
    --bg:#0f1115;
    --page-gap:#15171c;
    --card:#181a20;
    --card-strong:#1d1f27;
    --panel:#1b1d25;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --shadow:0 6px 16px rgba(0,0,0,.35);
    --shadow-strong:0 10px 32px rgba(0,0,0,.45);
    --brand:#3b82f6;
    --brand-dark:#2563eb;
}

*{box-sizing:border-box;font-family:Inter,Arial;}

body{
    margin:0;
    background:linear-gradient(180deg,var(--page-gap),var(--bg) 50%);
    color:var(--text);
    padding-bottom:60px;
}

/* MENU SUPERIOR */
.top-menu{
  position:fixed;
  top:0;left:0;width:100%;
  background:var(--panel);
  display:flex;
  padding:8px;
  gap:8px;
  align-items:center;
  z-index:9999;
  overflow-x:auto;
  box-shadow:var(--shadow);
}
.top-menu button{
  padding:10px 14px;
  background:var(--card);
  border:1px solid rgba(0,0,0,0.08);
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  flex-shrink:0;
  color:var(--text);
}

body{padding-top:70px;}

/* HEADER */
header{
    padding:18px 16px;
    max-width:980px;
    margin:0 auto 14px auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
}

#toggleTheme{
    background:var(--card-strong);
    padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.1);
    font-weight:700;cursor:pointer;color:var(--text);
}

.container{max-width:980px;margin:0 auto;padding:0 16px;}

.card{
    background:var(--card);
    border-radius:var(--radius);
    padding:20px;
    margin-bottom:18px;
    border:1px solid #d7dce2;
    box-shadow:var(--shadow);
}
.card h3{margin:0 0 12px}

.label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block;}
input{
    width:100%;padding:12px;border-radius:10px;
    border:1px solid #cfd4da;background:var(--panel);
    color:var(--text);margin-bottom:12px;font-size:15px;
}

.row{display:flex;gap:14px;flex-wrap:wrap;}
.col{flex:1;min-width:160px;}

.btn{
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    color:#fff;padding:12px;border:none;width:100%;
    border-radius:12px;font-weight:700;cursor:pointer;
}
.btnGhost{
    background:var(--card-strong);color:var(--text);
    padding:11px;border:none;width:100%;
    border-radius:10px;font-weight:600;cursor:pointer;
}

.listItem{
    background:var(--card-strong);
    padding:14px;border-radius:12px;margin-bottom:12px;
    display:flex;justify-content:space-between;gap:12px;
}
.hint{font-size:13px;color:var(--muted);}

.badge{padding:6px 10px;border-radius:10px;font-size:13px;font-weight:700;}
.statusGreen{background:#d7fbe3;color:#0b6620;}
.statusWarn{background:#fff4d6;color:#9d6700;}
.statusRed{background:#ffe3e3;color:#a00000;}

.dark .statusGreen{background:#114222;color:#9dffc1;}
.dark .statusWarn{background:#6a4c09;color:#ffeab3;}
.dark .statusRed{background:#5a0a06;color:#ffb3b3;}

.table{width:100%;border-collapse:collapse;font-size:14px;}
.table th{padding:8px;font-size:12px;color:var(--muted);}
.table td{padding:8px;}

#modalMaquineta{
    position:fixed;inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    z-index:2000;
    padding-top:40px;
}
.modalBox{
    background:var(--card);
    width:92%;max-width:420px;
    padding:20px;border-radius:14px;
    margin:auto;box-shadow:var(--shadow-strong);
}
</style>
</head>

<body>

<div class="top-menu">
  <button onclick="location.href='planos.html'">üíé Planos</button>
  <button onclick="location.href='perfil.html'">üë§ Perfil</button>
  <button onclick="location.href='index.html'">üè† Dashboard</button>
  <button onclick="location.href='entradas.html'">üíµ Caixa</button>
  <button onclick="location.href='resumo.html'">üßÆ Resumo</button>
  <button onclick="location.href='recibo_empresa.html'">üè≠ Empresa</button>
  <button onclick="location.href='recibo_particular.html'">üöò Particular</button>
  <button onclick="location.href='manutencao.html'">üõ† Manuten√ß√£o</button>
  <button onclick="location.href='calculadora.html'">üìü Calculadora</button>
</div>

<header>
    <div class="brand">
        <div class="logo">RF Driver</div>
        <h1 style="font-weight:800;font-size:28px;margin:0">Manuten√ß√£o</h1>
    </div>
    <button id="toggleTheme">üåô</button>
</header>

<div class="container">

<!-- DADOS DO VE√çCULO -->
<div class="card">
    <h3>Dados do Ve√≠culo / KM Atual</h3>

    <div class="row">
        <div class="col">
            <label class="label">Nome / Propriet√°rio</label>
            <input id="perfilNome" type="text" placeholder="Nome do propriet√°rio">
        </div>

        <div class="col">
            <label class="label">Marca</label>
            <input id="perfilMarca" type="text" placeholder="Marca">
        </div>

        <div class="col">
            <label class="label">Modelo</label>
            <input id="perfilModelo" type="text" placeholder="Modelo">
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label class="label">Ano</label>
            <input id="perfilAno" type="text" placeholder="Ano">
        </div>

        <div class="col">
            <label class="label">Placa</label>
            <input id="perfilPlaca" type="text" placeholder="Placa">
        </div>

        <div class="col">
            <label class="label">KM atual</label>
            <input id="kmAtual" type="number" placeholder="KM atual">
        </div>
    </div>

    <div class="row" style="margin-top:10px;">
        <button id="salvarPerfil" class="btn" style="flex:2;">Salvar / Atualizar KM</button>
        <button id="limparPerfil" class="btnGhost" style="flex:1;">Recarregar</button>
    </div>

    <div class="row" style="margin-top:10px;">
        <button id="exportWhats" class="btnGhost">WhatsApp</button>
        <button id="exportPdf" class="btnGhost">PDF</button>
    </div>

</div>

<!-- CADASTRAR MANUTEN√á√ÉO -->
<div class="card">
    <h3>Cadastrar manuten√ß√£o / item</h3>

    <label class="label">Nome</label>
    <input id="mNome" type="text" placeholder="Ex: Troca de √≥leo">

    <div class="row">
        <div class="col">
            <label class="label">KM √∫ltima troca</label>
            <input id="mKmUltima" type="number" placeholder="KM">
        </div>

        <div class="col">
            <label class="label">Intervalo (km)</label>
            <input id="mIntervalo" type="number" placeholder="Intervalo em km">
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label class="label">Custo estimado</label>
            <input id="mCusto" type="number" step="0.01" placeholder="R$">
        </div>

        <div class="col">
            <label class="label">Observa√ß√£o</label>
            <input id="mObs" type="text" placeholder="Observa√ß√µes">
        </div>
    </div>

    <div class="row" style="margin-top:10px;">
        <button id="addManut" class="btn" style="flex:2;">Adicionar / Salvar</button>
        <button id="limparFormManut" class="btnGhost" style="flex:1;">Limpar</button>
    </div>
</div>

<!-- LISTA -->
<div class="card">
    <h3>Manuten√ß√µes cadastradas</h3>
    <div id="listaManutencoes"></div>
</div>

<!-- HISTORICO -->
<div class="card">
    <h3>Hist√≥rico</h3>
    <div style="width:100%; overflow-x:auto;">
        <table class="table" id="histTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Nome</th>
                    <th>KM</th>
                    <th>Valor</th>
                    <th>Obs</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

</div> <!-- fecha container -->

<!-- Modal Maquineta (mantido, caso use no futuro em manuten√ß√£o/pagamento) -->
<div id="modalMaquineta">
    <div class="modalBox">
        <h3 style="margin-top:0;">Cadastrar Maquineta</h3>

        <input id="maqNome" type="text" placeholder="Nome da maquineta">
        <input id="maqDebito" type="number" placeholder="Taxa d√©bito (%)">
        <input id="maqCreditoAvista" type="number" placeholder="Taxa cr√©dito √† vista (%)">
        <input id="maq2x" type="number" placeholder="Taxa 2x (%)">
        <input id="maq3x" type="number" placeholder="Taxa 3x (%)">
        <input id="maq4x" type="number" placeholder="Taxa 4x (%)">
        <input id="maq5x" type="number" placeholder="Taxa 5x (%)">

        <div style="display:flex; gap:10px; margin-top:16px;">
            <button type="button" id="btnSalvarMaquineta" class="btn">Salvar</button>
            <button type="button" id="btnCancelarMaquineta" class="btnGhost" style="background:var(--accent-danger);color:#fff;">Cancelar</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="planos.js"></script>

<script>
/* BLOQUEIO DE PLANO: MANUTEN√á√ÉO APENAS PRO */
function plano(){
  try{ return getPlano(); }catch(e){}
  return (localStorage.getItem('planoAtual') || 'free').toLowerCase();
}
(function(){
  const p = plano();
  if(p !== 'pro'){
     alert("A p√°gina Manuten√ß√£o √© liberada apenas no plano PRO.");
     window.location.href = "planos.html";
     return;
  }
})();

/* THEME */
function applyTheme(theme){
    const html = document.documentElement;
    const btn = document.getElementById('toggleTheme');
    if(theme === 'dark'){
        html.classList.add('dark');
        localStorage.setItem('theme','dark');
        if(btn) btn.innerText = "‚òÄÔ∏è";
    } else {
        html.classList.remove('dark');
        localStorage.setItem('theme','light');
        if(btn) btn.innerText = "üåô";
    }
}

(function initTheme(){
    const saved = localStorage.getItem('theme') || 'light';
    applyTheme(saved);
    const btn = document.getElementById('toggleTheme');
    if(btn){
        btn.addEventListener("click", ()=>{
            const isDark=document.documentElement.classList.contains("dark");
            applyTheme(isDark?"light":"dark");
        });
    }
})();

/* HELPERS */
const $ = id => document.getElementById(id);
const currency = v => Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const now = () => new Date().toISOString();
const esc = t => t ? String(t).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : "";

const load = key=>{
   try{
      const raw = localStorage.getItem(key);
      if(!raw){
        if(key==='manutHistorico') return [];
        if(key==='manutencoes') return [];
        return {};
      }
      return JSON.parse(raw);
   }catch(e){
      return (key==='manutHistorico' || key==='manutencoes') ? [] : {};
   }
}
const save = (k,v)=>localStorage.setItem(k, JSON.stringify(v));

/* PERFIL / VE√çCULO */
function renderPerfil(){
    const p = load("perfilMotorista");
    $("perfilNome").value = p.nome || "";
    $("perfilMarca").value = p.carro || "";
    $("perfilModelo").value = p.modelo || "";
    $("perfilAno").value = p.ano || "";
    $("perfilPlaca").value = p.placa || "";
    $("kmAtual").value = p.kmAtual || "";
}

function salvarPerfil(){
   const p = load("perfilMotorista");
   p.nome = $("perfilNome").value.trim();
   p.carro = $("perfilMarca").value.trim();
   p.modelo = $("perfilModelo").value.trim();
   p.ano = $("perfilAno").value.trim();
   p.placa = $("perfilPlaca").value.trim();

   const km = Number($("kmAtual").value);
   if(km || km===0) p.kmAtual = km;
   save("perfilMotorista", p);

   const man = load("manutencoes");
   man.forEach(m=>calc(m,p.kmAtual||0));
   save("manutencoes",man);

   renderManutencoes();
   alert("Dados salvos!");
}

/* MANUTEN√á√ïES */
function calc(m, kmAtual){
   m.kmProxima = Number(m.kmUltimaTroca) + Number(m.intervaloKm);
   m.kmRestante = m.kmProxima - (Number(kmAtual)||0);
   m.valorPorKm = (Number(m.custoEstimado)||0)/(Number(m.intervaloKm)||1);
}

function renderManutencoes(){
   const box = $("listaManutencoes");
   box.innerHTML="";
   const man = load("manutencoes");
   const perfil = load("perfilMotorista");
   const kmAtual = Number(perfil.kmAtual||0);

   man.forEach(m=>calc(m,kmAtual));
   man.sort((a,b)=>a.kmRestante-b.kmRestante);
   save("manutencoes",man);

   if(!man.length){
      box.innerHTML="<div class='hint'>Nenhuma manuten√ß√£o cadastrada</div>";
      return;
   }

   man.forEach(m=>{
      const color =
        m.kmRestante <=800 ? "statusRed":
        m.kmRestante <=2000 ? "statusWarn" : "statusGreen";

      const div=document.createElement("div");
      div.className="listItem";
      div.innerHTML=`
        <div style="flex:1;">
          <div style="font-weight:700;">${esc(m.nome)}</div>
          <div class="hint">√öltima: ${esc(m.kmUltimaTroca)} ‚Ä¢ Pr√≥x: ${esc(m.kmProxima)}</div>
          <div class="hint">Custo: ${currency(m.custoEstimado)}</div>
          ${m.obs?`<div class="hint">${esc(m.obs)}</div>`:""}
        </div>

        <div style="text-align:right;">
          <div class="badge ${color}">${m.kmRestante} km</div>

          <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
            <button class="btnGhost" onclick="editar(${m.id})">Editar</button>
            <button class="btnGhost" onclick="remover(${m.id})">Remover</button>
            <button class="btn" onclick="realizada(${m.id})">Realizar</button>
          </div>
        </div>
      `;
      box.appendChild(div);
   });
}

function adicionar(){
   const nome=$("mNome").value.trim();
   const u=Number($("mKmUltima").value);
   const i=Number($("mIntervalo").value);

   if(!nome || !u || !i) return alert("Preencha nome, KM e intervalo.");

   const custo=Number($("mCusto").value);
   const obs=$("mObs").value.trim();
   const perfil=load("perfilMotorista");
   const kmAtual=Number(perfil.kmAtual||0);

   const m={
      id:Date.now(),
      nome,
      kmUltimaTroca:u,
      intervaloKm:i,
      custoEstimado:custo,
      obs,
      criadoEm:now()
   };
   calc(m,kmAtual);

   const arr=load("manutencoes");
   arr.push(m);
   save("manutencoes",arr);

   renderManutencoes();
   limparFormManut();
}

function editar(id){
   const arr=load("manutencoes");
   const m=arr.find(x=>x.id===id);
   if(!m) return;

   $("mNome").value=m.nome;
   $("mKmUltima").value=m.kmUltimaTroca;
   $("mIntervalo").value=m.intervaloKm;
   $("mCusto").value=m.custoEstimado;
   $("mObs").value=m.obs;

   remover(id);
   window.scrollTo({top:0,behavior:"smooth"});
}

function remover(id){
   if(!confirm("Deseja remover?")) return;
   const arr=load("manutencoes").filter(x=>x.id!==id);
   save("manutencoes",arr);
   renderManutencoes();
}

function realizada(id){
   const arr=load("manutencoes");
   const m=arr.find(x=>x.id===id);
   if(!m) return;

   const perfil=load("perfilMotorista");
   const kmAtual=Number(perfil.kmAtual||0);

   const km=Number(prompt("KM da troca:",kmAtual));
   if(!km && km!==0) return;

   const valor=Number(prompt("Valor pago:",m.custoEstimado))||0;
   const obs=prompt("Obs:","")||"";

   const hist=load("manutHistorico");
   hist.push({
      id:Date.now(),
      nome:m.nome,
      kmTroca:km,
      custoPago:valor,
      data:now(),
      obs
   });
   save("manutHistorico",hist);

   m.kmUltimaTroca=km;
   calc(m,kmAtual);
   save("manutencoes",arr);

   if(km > kmAtual){
      perfil.kmAtual=km;
      save("perfilMotorista",perfil);
      renderPerfil();
   }

   renderManutencoes();
   renderHistorico();
   alert("Manuten√ß√£o registrada!");
}

/* HIST√ìRICO */
function renderHistorico(){
  const hist=load("manutHistorico");
  const tbody=document.querySelector("#histTable tbody");
  tbody.innerHTML="";

  if(!hist.length){
    tbody.innerHTML="<tr><td colspan='5' class='hint'>Nenhum registro</td></tr>";
    return;
  }

  hist.slice().reverse().forEach(h=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${new Date(h.data).toLocaleString()}</td>
      <td>${esc(h.nome)}</td>
      <td>${h.kmTroca}</td>
      <td>${currency(h.custoPago)}</td>
      <td>${esc(h.obs)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* EXPORTS */
function exportWhats(){
  const p=load("perfilMotorista");
  const man=load("manutencoes")||[];

  let msg=`Relat√≥rio de Manuten√ß√£o - ${new Date().toLocaleDateString()}\n\n`;
  msg+=`Ve√≠culo: ${p.carro||""} ${p.modelo||""} - Placa: ${p.placa||""}\nKM Atual: ${p.kmAtual||0}\n\n`;

  man.forEach(m=>{
    msg+=`‚Ä¢ ${m.nome}: Pr√≥x ${m.kmProxima} (${m.kmRestante} km)\n`;
  });

  window.open("https://wa.me/?text="+encodeURIComponent(msg),"_blank");
}

async function exportPdf(){
  const el=document.querySelector(".container");
  if(!el) return alert("Erro ao gerar PDF.");
  try{
    const canvas=await html2canvas(el,{scale:2});
    const img=canvas.toDataURL("image/png");
    const {jsPDF}=window.jspdf;
    const pdf=new jsPDF("p","mm","a4");
    const W=pdf.internal.pageSize.getWidth();
    const H=canvas.height*(W/canvas.width);
    pdf.addImage(img,"PNG",0,0,W,H);
    pdf.save("manutencao.pdf");
  }catch(e){
    alert("Falha ao exportar PDF.");
  }
}

/* UTIL */
function limparFormManut(){
   $("mNome").value="";
   $("mKmUltima").value="";
   $("mIntervalo").value="";
   $("mCusto").value="";
   $("mObs").value="";
}

/* BOOT */
(function boot(){
   renderPerfil();
   renderManutencoes();
   renderHistorico();

   $("salvarPerfil").onclick=salvarPerfil;
   $("limparPerfil").onclick=()=>{renderPerfil();renderManutencoes();renderHistorico()};
   $("addManut").onclick=adicionar;
   $("limparFormManut").onclick=limparFormManut;
   $("exportWhats").onclick=exportWhats;
   $("exportPdf").onclick=exportPdf;
})();
</script>
</body>
</html>
