<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Central de Solicita√ß√µes ‚Äì RF DRIVER</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="./theme/theme.css">

<style>
.page{
  min-height:100vh;
  padding:20px;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:500px;
  display:flex;
  flex-direction:column;
  gap:18px;
}

.header{
  padding:20px;
  border-radius:18px;
  background:linear-gradient(180deg,var(--card),#0b2238);
  color:#fff;
  text-align:center;
}

  .header h2{
  color:#ffffff !important;
}

.card{
  background:#fff;
  padding:16px;
  border-radius:18px;
  box-shadow:0 8px 22px rgba(0,0,0,.08);
}

.status{
  font-size:.75rem;
  padding:4px 8px;
  border-radius:12px;
  font-weight:700;
}

.status-aberto{
  background:#facc15;
  color:#000;
}

.status-atendimento{
  background:#22c55e;
  color:#fff;
}

.btn{
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
}

.btn-aceitar{
  background:#22c55e;
  color:#fff;
}
</style>
</head>

<body>

<div class="page">
<div class="container">

<div class="header">
  <h2>Central de Solicita√ß√µes</h2>
</div>

<div id="listaSolicitacoes"></div>

</div>
</div>

<script src="core/global.js"></script>

<script>
const STORAGE_SOLICITACOES = "rf_driver_solicitacoes";
const STORAGE_HISTORICO = "rf_driver_historico";

function getSolicitacoes(){
  return JSON.parse(localStorage.getItem(STORAGE_SOLICITACOES) || "[]");
}

function setSolicitacoes(arr){
  localStorage.setItem(STORAGE_SOLICITACOES, JSON.stringify(arr));
}

function getHistorico(){
  return JSON.parse(localStorage.getItem(STORAGE_HISTORICO) || "[]");
}

function setHistorico(arr){
  localStorage.setItem(STORAGE_HISTORICO, JSON.stringify(arr));
}

// ==========================
// CRIAR NOVA SOLICITA√á√ÉO
// ==========================
function criarSolicitacao(){

  const origem = App.get("origem");
  const destino = App.get("destino");
  const total = App.get("total");
  const pagamento = App.get("formaPagamento");
  const config = App.get("taxasConfig") || {};

  if(!origem || !destino || !total) return;

  // ==========================
  // GERAR DETALHAMENTO
  // ==========================
  let detalhes = [];

  if(config.tipoViagem)
    detalhes.push("üöñ Tipo: " + config.tipoViagem.replaceAll("_"," "));

  if(config.desvioSimples)
    detalhes.push("üõ£Ô∏è Desvio r√°pido");

  if(config.voltaPraia)
    detalhes.push("üèñÔ∏è Volta das praias");

  if(config.taxaFeira)
    detalhes.push("üõí Taxa de feira");

  if(config.veiculo6)
    detalhes.push("üöê Ve√≠culo 6 lugares");

  if(config.taxaNoturna)
    detalhes.push("üåô Adicional noturno");

  if(Number(config.animal) > 0)
    detalhes.push("üê∂ Transporte animal");

  if(Number(config.minutosEspera) >= 5)
    detalhes.push("‚è±Ô∏è Tempo de espera (" + config.minutosEspera + " min)");

  if(config.observacao)
    detalhes.push("üìù " + config.observacao);

  const nova = {
    id: Date.now(),
    origem,
    destino,
    total,
    pagamento,
    detalhes,
    status: "aberto",
    criadoEm: new Date().toLocaleString("pt-BR")
  };

  const lista = getSolicitacoes();
  lista.unshift(nova);
  setSolicitacoes(lista);
}

// ==========================
// ADICIONAR AO HIST√ìRICO
// ==========================
function adicionarHistorico(corrida){

  let historico = getHistorico();

  historico.unshift({
    ...corrida,
    status: "realizada",
    finalizadaEm: new Date().toLocaleString("pt-BR")
  });

  if(historico.length > 25){
    historico = historico.slice(0,25);
  }

  setHistorico(historico);
}

// ==========================
// CANCELAR
// ==========================
function cancelar(id){

  const confirmar = confirm("Deseja realmente cancelar esta solicita√ß√£o?");
  if(!confirmar) return;

  let lista = getSolicitacoes();
  lista = lista.filter(s => s.id !== id);

  setSolicitacoes(lista);
  render();
}

// ==========================
// ACEITAR
// ==========================
function aceitar(id){

  let lista = getSolicitacoes();
  const index = lista.findIndex(s=>s.id === id);

  if(index === -1) return;

  const corrida = lista[index];

  // Remove da central
  lista.splice(index,1);
  setSolicitacoes(lista);

  // Envia para hist√≥rico
  adicionarHistorico(corrida);

  render();
}

// ==========================
// RENDERIZAR
// ==========================
function render(){

  const lista = getSolicitacoes();
  const container = document.getElementById("listaSolicitacoes");

  if(lista.length === 0){
    container.innerHTML = "<div class='card'>Nenhuma solicita√ß√£o aberta.</div>";
    return;
  }

  container.innerHTML = lista.map(s=>`
    <div class="card">
      <strong>${s.origem} ‚Üí ${s.destino}</strong><br>
      <small>${s.criadoEm}</small><br><br>

      üí∞ <strong>R$ ${Number(s.total).toFixed(2)}</strong><br>
      üí≥ ${s.pagamento}<br>

      ${s.observacao ? `<br>üìù ${s.observacao}<br>` : ""}

      <span class="status status-aberto">
        AGUARDANDO MOTORISTA
      </span>

      <button class="btn btn-aceitar" onclick="aceitar(${s.id})">
        Aceitar Corrida
      </button>

      <button class="btn btn-cancelar" onclick="cancelar(${s.id})" style="background:#ef4444;color:#fff;">
        Cancelar Solicita√ß√£o
      </button>
    </div>
  `).join("");
}

// ==========================
// INICIALIZA√á√ÉO
// ==========================
criarSolicitacao();
render();
</script>

</body>
</html>
