<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>RF â€“ Procurando Motorista</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="core/global.js"></script>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
}

body{
  background:#fff;
  height:100vh;
  overflow:hidden;
}

/* ===== TOPO ===== */

.top{
  background:#facc15;
  padding:25px 20px 120px;
  border-bottom-left-radius:40px;
  border-bottom-right-radius:40px;
}

.logo{
  font-weight:900;
  font-size:1.4rem;
}

.status{
  margin-top:5px;
  font-weight:700;
}

/* ===== MAPA FAKE ===== */

.map{
  position:absolute;
  top:140px;
  left:0;
  right:0;
  bottom:0;
  background:radial-gradient(circle at 30% 30%, #e5e5e5 0%, #f5f5f5 60%);
  overflow:hidden;
}

/* Pontos animados simulando motoristas */

.dot{
  position:absolute;
  width:10px;
  height:10px;
  background:#facc15;
  border-radius:50%;
  animation:pulse 2s infinite;
}

@keyframes pulse{
  0%{transform:scale(1); opacity:1;}
  50%{transform:scale(1.5); opacity:.4;}
  100%{transform:scale(1); opacity:1;}
}

/* ===== CARD INFERIOR ===== */

.card{
  position:absolute;
  bottom:0;
  left:0;
  right:0;
  background:#fff;
  border-top-left-radius:25px;
  border-top-right-radius:25px;
  padding:20px;
  box-shadow:0 -10px 30px rgba(0,0,0,.1);
  animation:slideUp .4s ease;
}

@keyframes slideUp{
  from{transform:translateY(40px); opacity:0;}
  to{transform:translateY(0); opacity:1;}
}

.spinner{
  width:40px;
  height:40px;
  border:4px solid #eee;
  border-top:4px solid #facc15;
  border-radius:50%;
  margin:0 auto 15px;
  animation:spin 1s linear infinite;
}

@keyframes spin{
  to{transform:rotate(360deg);}
}

.route{
  text-align:center;
  font-size:.85rem;
  margin-bottom:10px;
}

.categoria{
  text-align:center;
  font-size:.8rem;
  color:#666;
}

.total{
  text-align:center;
  font-size:1.6rem;
  font-weight:800;
  margin-top:10px;
}

.timer{
  text-align:center;
  font-size:.75rem;
  color:#888;
  margin-top:6px;
}

.btn-cancel{
  margin-top:15px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  background:#fff;
  border:1px solid #ef4444;
  color:#ef4444;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}

.btn-cancel:active{
  transform:scale(.97);
}
</style>
</head>
<body>

<div class="top">
  <div class="logo">RF</div>
  <div class="status" id="statusText">Buscando motoristas prÃ³ximos...</div>
</div>

<div class="map">
  <div class="dot" style="top:30%; left:20%;"></div>
  <div class="dot" style="top:50%; left:60%; animation-delay:1s;"></div>
  <div class="dot" style="top:70%; left:35%; animation-delay:1.5s;"></div>
</div>

<div class="card">

  <div class="spinner"></div>

  <div class="route">
    <strong id="origem"></strong>
    <br>â†“<br>
    <strong id="destino"></strong>
  </div>

  <div class="categoria" id="categoria"></div>

  <div class="total" id="total"></div>

  <div class="timer" id="timer">
    Tempo de espera: 0s
  </div>

  <button class="btn-cancel" onclick="cancelar()">
    Cancelar corrida
  </button>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="core/supabase.js"></script>

<script>

const origem = App.get("origem") || "-";
const destino = App.get("destino") || "-";
const total = Number(App.get("total") || 0);
const categoriaSelecionada = App.get("categoria") || "Driver";

document.getElementById("origem").innerText = origem;
document.getElementById("destino").innerText = destino;
document.getElementById("total").innerText = "R$ " + total.toFixed(2);
document.getElementById("categoria").innerText = categoriaSelecionada;

let segundos = 0;

setInterval(()=>{
  segundos++;
  document.getElementById("timer").innerText =
    "Tempo de espera: " + segundos + "s";

  if(segundos === 5){
    document.getElementById("statusText").innerText =
      "Motoristas visualizando sua corrida...";
  }

  if(segundos === 10){
    document.getElementById("statusText").innerText =
      "Conectando com o melhor motorista...";
  }

},1000);

/* ===== CANCELAR ===== */

function cancelar(){
  if(confirm("Deseja cancelar a corrida?")){
    App.reset();
    App.go("viagem.html");
  }
}

/* ===== BACKEND (INALTERADO) ===== */

async function criarCorrida() {

  const { data, error } = await supabaseClient
    .from("rides")
    .insert([
      {
        origem: origem,
        destino: destino,
        valor: total,
        categoria: categoriaSelecionada,
        status: "procurando"
      }
    ])
    .select()
    .single();

  if (error) {
    alert("Erro ao criar corrida.");
    return;
  }

  App.set("ride_id", data.id);
  escutarAceite(data.id);
}

function escutarAceite(rideId){

  supabaseClient
    .channel("ride-" + rideId)
    .on(
      "postgres_changes",
      {
        event: "UPDATE",
        schema: "public",
        table: "rides",
        filter: "id=eq." + rideId
      },
      (payload) => {

        if(payload.new.status === "aceita"){
          document.getElementById("statusText").innerText =
            "Motorista encontrado! ðŸš—";

          setTimeout(()=>{
            App.go("motorista-caminho.html");
          },1500);
        }

      }
    )
    .subscribe();
}

criarCorrida();

</script>

</body>
</html>