<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard - Motorista App</title>
<style>
:root{
    --bg:#121212; --card:#1E1E1E; --panel:#2A2A2A; --accent:#1DB954; --danger:#ff3b30; --muted:#bbb;
}
body{
    margin:0; font-family:Arial, Helvetica, sans-serif; background:var(--bg); color:#fff; padding-bottom:140px;
}
header{ background:var(--accent); padding:14px; text-align:center; color:#000; font-weight:700; font-size:20px;}
.container{ max-width:980px; margin:12px auto; padding:0 16px; box-sizing:border-box; }

/* greeting */
#greeting{ text-align:center; color:var(--accent); margin:10px 0; font-size:18px; }

/* layout main */
.card-lucro {
    background: var(--card);
    border-radius:12px;
    padding:20px;
    text-align:center;
    margin:12px 0;
    box-shadow:0 6px 18px rgba(0,0,0,0.5);
    transition: box-shadow .5s ease, transform .2s ease;
}
.card-lucro .label{ color:var(--muted); font-size:14px; }
.card-lucro .valor{ font-size:36px; font-weight:800; margin-top:6px; }

/* glow animations */
@keyframes glowGreen { 0%{ box-shadow:0 0 0 rgba(0,0,0,0);}50%{ box-shadow:0 0 20px rgba(29,185,84,0.45);}100%{ box-shadow:0 0 0 rgba(0,0,0,0);} }
@keyframes glowRed   { 0%{ box-shadow:0 0 0 rgba(0,0,0,0);}50%{ box-shadow:0 0 20px rgba(255,59,48,0.45);}100%{ box-shadow:0 0 0 rgba(0,0,0,0);} }

/* small cards row */
.row { display:flex; gap:16px; flex-wrap:wrap; margin-bottom:12px; }
.card-small { flex:1 1 48%; background:var(--card); border-radius:10px; padding:14px; text-align:center; box-shadow:0 6px 18px rgba(0,0,0,0.4); min-width:200px; }
.card-small .title{ color:var(--muted); font-size:13px; }
.card-small .value{ font-size:22px; font-weight:700; margin-top:8px; color:var(--accent); }

/* force gastos red */
.card-small .value.gastos { color: var(--danger) !important; }

/* meta daily panel */
.meta-card { background:var(--card); border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,0.5); margin-top:12px; }
.progressWrap{ display:flex; gap:20px; align-items:center; flex-wrap:wrap; }
.circular { width:120px; height:120px; position:relative; }
.circular svg{ transform:rotate(-90deg); }
.circular .label{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; }
.circular .pct{ font-size:18px; font-weight:800; }

.progressBar{ width:100%; height:14px; background:#0e0e0e; border-radius:10px; overflow:hidden; margin-top:8px; }
.progressBar .fill{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#0ab85a); transition: width .6s ease; }

.metrics{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.metric{ flex:1; background:linear-gradient(180deg,#151515,#1b1b1b); padding:10px; border-radius:8px; text-align:center; }
.metric h4{ margin:0; font-size:13px; color:var(--muted); }
.metric .big{ margin-top:6px; font-size:16px; font-weight:800; color:var(--accent); }

/* mini bar chart */
.chartRow{ display:flex; gap:12px; align-items:flex-end; justify-content:center; padding:12px 0; }
.bar{ width:80px; background:#0b0b0b; border-radius:8px 8px 0 0; display:flex; align-items:flex-end; justify-content:center; padding-top:6px; box-sizing:border-box; }
.bar .inner{ width:70%; background:var(--accent); border-radius:6px 6px 0 0; transition:height .6s ease; display:flex; align-items:flex-end; justify-content:center; color:#000; font-weight:700; padding-bottom:6px; }
.bar .label{ margin-top:8px; font-size:12px; color:var(--muted); text-align:center; }

/* alert */
.alert{ margin-top:10px; padding:10px; border-radius:8px; background:#2a1515; color:var(--danger); font-weight:700; display:none; text-align:center; }

/* bottom menu */
.bottom-menu{ position:fixed; bottom:15px; left:50%; transform:translateX(-50%); width:88%; background:#1B1B1B; padding:10px 0; border-radius:18px; display:flex; justify-content:space-around; box-shadow:0 6px 25px rgba(0,0,0,0.6); z-index:1000; }
.bottom-menu .menu-item{ text-align:center; color:#fff; text-decoration:none; font-size:13px; display:flex; flex-direction:column; align-items:center; }
.bottom-menu .menu-item .icon{ font-size:22px; margin-bottom:4px; }
.bottom-menu .menu-item.active{ color:var(--accent); }

@media(max-width:720px){
    .row { flex-direction:column; }
    .card-small { width:100%; }
    .progressWrap { justify-content:center; }
    .chartRow .bar { width:28%; }
}
</style>
</head>
<body>

<header>Dashboard</header>
<div id="greeting"></div>

<div class="container">

    <!-- LUCRO ESTIMADO -->
    <div id="cardLucro" class="card-lucro" role="region" aria-label="Lucro estimado">
        <div class="label">Lucro Estimado</div>
        <div id="lucroValor" class="valor">R$ 0,00</div>
    </div>

    <!-- ROW: gastos (left) and faturado (right) -->
    <div class="row">
        <div class="card-small" role="region" aria-label="Gastos do dia">
            <div class="title">Gastos do Dia</div>
            <div id="gastosDia" class="value gastos">R$ 0,00</div>
        </div>

        <div class="card-small" role="region" aria-label="Total faturado hoje">
            <div class="title">Total Faturado Hoje</div>
            <div id="totalFaturado" class="value">R$ 0,00</div>
        </div>
    </div>

    <!-- META DI√ÅRIA PANEL (COMPLETO PARA O DIA) -->
    <div class="meta-card" role="region" aria-label="Meta di√°ria">
        <h3 style="margin:0 0 8px 0;">Acompanhamento - Meta Di√°ria</h3>

        <div class="progressWrap">
            <div class="circular" id="circularWrap"></div>

            <div style="flex:1; min-width:220px;">
                <div style="color:var(--muted);font-size:13px;">Meta di√°ria</div>
                <div id="labelMetaDia" style="font-weight:800;font-size:18px;margin-top:6px;">R$ 0,00</div>

                <div style="color:var(--muted);font-size:13px;margin-top:8px;">Feito hoje (l√≠quido)</div>
                <div id="feitoHoje" style="font-weight:800;font-size:18px;margin-top:6px;">R$ 0,00</div>

                <div style="color:var(--muted);font-size:13px;margin-top:8px;">Diferen√ßa</div>
                <div id="diffHoje" style="font-weight:800;font-size:18px;margin-top:6px;">R$ 0,00</div>

                <div style="margin-top:12px;">
                    <div class="progressBar"><div class="fill" id="linearFill" style="width:0%"></div></div>
                    <div style="font-size:12px;color:var(--muted);margin-top:6px;">Progresso do dia</div>
                </div>
            </div>
        </div>

        <div style="margin-top:12px;">
            <div class="chartRow" aria-hidden="false">
                <div class="bar"><div class="inner" id="barMeta" style="height:10%"></div><div class="label">Meta</div></div>
                <div class="bar"><div class="inner" id="barHoje" style="height:10%"></div><div class="label">Hoje</div></div>
            </div>
        </div>

        <div id="alertDaily" class="alert">Voc√™ est√° abaixo da meta di√°ria ‚Äî ajuste seu fluxo.</div>
    </div>

</div>

<!-- bottom menu -->
<nav class="bottom-menu" aria-label="Menu">
    <a href="index.html" class="menu-item active"><span class="icon">üè†</span><span>Dashboard</span></a>
    <a href="entradas.html" class="menu-item"><span class="icon">üíµ</span><span>Entradas</span></a>
    <a href="manutencao.html" class="menu-item"><span class="icon">üõ†Ô∏è</span><span>Manuten√ß√£o</span></a>
    <a href="resumo.html" class="menu-item"><span class="icon">üìä</span><span>Resumo</span></a>
    <a href="perfil.html" class="menu-item"><span class="icon">üë§</span><span>Perfil</span></a>
    <a href="calculadora.html" class="menu-item"><span class="icon">üìü</span><span>Calc</span></a>
</nav>

<script>
/* HELPERS */
const $ = id => document.getElementById(id);
const brl = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

function isSameDayISO(isoDateStr){
    if(!isoDateStr) return false;
    const d = new Date(isoDateStr);
    const now = new Date();
    return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate();
}
function isSameMonthISO(isoDateStr){
    if(!isoDateStr) return false;
    const d = new Date(isoDateStr);
    const now = new Date();
    return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth();
}

/* LOAD DATA */
function loadState(){
    const registros = JSON.parse(localStorage.getItem('entradasSaidas') || '[]');
    const metaObj = JSON.parse(localStorage.getItem('metaMensal') || '{}');
    const recebers = JSON.parse(localStorage.getItem('valoresReceber') || '[]');
    const perfil = JSON.parse(localStorage.getItem('perfilMotorista') || '{}');
    return { registros, metaObj, recebers, perfil };
}

/* CALCULOS DI√ÅRIOS */
/* soma apenas as ENTRADAS brutas do dia (mantido para exibi√ß√£o lado-a-lado) */
function somaFaturadoHojeBruto(registros){
    return registros.reduce((s,r)=>{
        if(r.tipo === 'entrada' && isSameDayISO(r.criadoEm)) return s + Number(r.valorBruto||0);
        return s;
    }, 0);
}

/* soma apenas as SA√çDAS do dia (mantido para exibi√ß√£o lado-a-lado) */
function somaGastosHoje(registros){
    return registros.reduce((s,r)=>{
        if(r.tipo === 'saida' && isSameDayISO(r.criadoEm)) return s + Number(r.valor||0);
        return s;
    }, 0);
}

/* soma apenas as ENTRADAS l√≠quidas do dia (para c√°lculo da meta real) */
function somaEntradasLiquidasHoje(registros){
    return registros.reduce((s,r)=>{
        if(r.tipo === 'entrada' && isSameDayISO(r.criadoEm)) return s + Number(r.valor||0);
        return s;
    }, 0);
}

/* calcula total a receber DENTRO do m√™s (valores cuja data prevista est√° no m√™s atual) */
function totalReceberNoMes(recebers){
    const now = new Date();
    return recebers.reduce((s,r)=>{
        if(!r.data) return s;
        const d = new Date(r.data);
        if(d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth()){
            return s + Number(r.valor||0);
        }
        return s;
    }, 0);
}

/* dias restantes no m√™s (inclui hoje) */
function diasRestantes(){
    const hoje = new Date();
    const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth()+1, 0).getDate();
    return Math.max(1, ultimoDia - hoje.getDate() + 1);
}

/* meta diaria = (metaMensal - totalReceberNoMes) / diasRestantes */
function calcularMetaDiaria(metaObj, recebers){
    const mensal = Number(metaObj.valor || 0);
    const totalR = totalReceberNoMes(recebers);
    const restante = mensal - totalR;
    const dias = diasRestantes();
    return dias>0 ? (restante / dias) : restante;
}

/* CIRCULAR RENDER */
function renderCircularDaily(pct){
    const size = 120;
    const stroke = 12;
    const radius = (size - stroke)/2;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference * (1 - Math.max(0, Math.min(pct,100))/100);
    const svg = `
      <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
        <defs>
          <linearGradient id="gDash" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#1DB954" />
            <stop offset="100%" stop-color="#0ab85a" />
          </linearGradient>
        </defs>
        <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="#0e0e0e" stroke-width="${stroke}" fill="none"></circle>
        <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="url(#gDash)" stroke-width="${stroke}" stroke-linecap="round"
            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" fill="none" style="transition:stroke-dashoffset .6s ease;"></circle>
      </svg>
    `;
    $('circularWrap').innerHTML = svg + `<div class="label" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;">
        <div class="pct">${pct}%</div>
        <div style="font-size:12px;color:var(--muted)">da meta di√°ria</div>
    </div>`;
}

/* UPDATE UI */
function updateDashboard(){
    const { registros, metaObj, recebers, perfil } = loadState();

    // greeting
    const firstName = perfil && perfil.nome ? perfil.nome.split(' ')[0] : '';
    $('greeting').innerText = firstName ? ('Ol√°, ' + firstName + '!') : '';

    // gastos / faturado / lucro (top)
    const gastos = somaGastosHoje(registros); // sa√≠das do dia
    const faturadoBruto = somaFaturadoHojeBruto(registros); // bruto do dia (mantido)
    const lucro = faturadoBruto - gastos;

    $('gastosDia').innerText = brl(gastos);
    $('totalFaturado').innerText = brl(faturadoBruto);
    $('lucroValor').innerText = brl(lucro);

    // apply color & animation to lucro card
    const card = $('cardLucro');
    const lucroEl = $('lucroValor');
    card.style.animation = '';
    setTimeout(()=>{ // reset animation reflow
        if(lucro > 0){
            lucroEl.style.color = 'var(--accent)';
            card.style.animation = 'glowGreen .6s ease-out';
        } else if(lucro < 0){
            lucroEl.style.color = 'var(--danger)';
            card.style.animation = 'glowRed .6s ease-out';
        } else {
            lucroEl.style.color = '#fff';
        }
    }, 20);

    // --- META DI√ÅRIA PANEL ---
    const metaDiaria = calcularMetaDiaria(metaObj, recebers);

    // novo c√°lculo: feitoHoje = entradas l√≠quidas do dia - sa√≠das do dia
    const entradasLiquidasHoje = somaEntradasLiquidasHoje(registros); // soma r.valor das entradas do dia
    const saidasHoje = somaGastosHoje(registros); // soma r.valor das sa√≠das do dia
    const feitoHoje = entradasLiquidasHoje - saidasHoje;

    const diff = feitoHoje - metaDiaria;
    const pct = metaDiaria > 0 ? Math.min(100, Math.round((feitoHoje / metaDiaria) * 100)) : (feitoHoje>0?100:0);

    $('labelMetaDia').innerText = brl(metaDiaria);
    $('feitoHoje').innerText = brl(feitoHoje);
    $('diffHoje').innerText = brl(diff);

    // circular
    renderCircularDaily(Math.round(pct));

    // linear fill
    $('linearFill').style.width = pct + '%';

    // mini bar chart heights relative
    const maxVal = Math.max(Math.abs(metaDiaria)||0, Math.abs(feitoHoje)||0, 1);
    const hMeta = Math.round((Math.abs(metaDiaria) / maxVal) * 100);
    const hHoje = Math.round((Math.abs(feitoHoje) / maxVal) * 100);
    $('barMeta').style.height = Math.max(6,hMeta) + '%';
    $('barHoje').style.height = Math.max(6,hHoje) + '%';
    // color bars
    $('barMeta').style.background = 'linear-gradient(180deg,#e0c050,#f2d66a)';
    $('barHoje').style.background = 'linear-gradient(180deg,#1DB954,#0fb85a)';

    // alert if below
    const alertEl = $('alertDaily');
    if(feitoHoje < metaDiaria){
        alertEl.style.display = 'block';
    } else {
        alertEl.style.display = 'none';
    }
}

/* boot */
window.addEventListener('focus', updateDashboard);
updateDashboard();

</script>
</body>
</html>
