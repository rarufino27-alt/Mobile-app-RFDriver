<!-- =========================================================
     MENU INFERIOR CORPORATIVO
     ========================================================= -->
<nav class="bottom-menu">
    <a href="index.html" class="menu-item">
        <span class="icon">üè†</span>
        <span>Dashboard</span>
    </a>

    <a href="entradas.html" class="menu-item">
        <span class="icon">üíµ</span>
        <span>Entradas</span>
    </a>

    <a href="manutencao.html" class="menu-item active">
        <span class="icon">üõ†Ô∏è</span>
        <span>Manuten√ß√£o</span>
    </a>

    <a href="resumo.html" class="menu-item">
        <span class="icon">üìä</span>
        <span>Resumo</span>
    </a>

    <a href="perfil.html" class="menu-item">
        <span class="icon">üë§</span>
        <span>Perfil</span>
    </a>

    <a href="calculadora.html" class="menu-item">
        <span class="icon">üìü</span>
        <span>Calc</span>
    </a>
</nav>

<!-- libs for PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* =========================================================
   TEMA GLOBAL (CLARO / ESCURO) ‚Äî SINCRONIZADO ENTRE P√ÅGINAS
   ========================================================= */
function applyTheme(){
    const theme = localStorage.getItem("themeMode") || "light";
    if(theme === "dark"){
        document.body.classList.add("dark");
        document.getElementById("toggleDarkBtn").textContent = "‚òÄÔ∏è";
    } else {
        document.body.classList.remove("dark");
        document.getElementById("toggleDarkBtn").textContent = "üåô";
    }
}

document.getElementById("toggleDarkBtn").addEventListener("click", () => {
    const theme = document.body.classList.contains("dark") ? "light" : "dark";
    localStorage.setItem("themeMode", theme);
    applyTheme();
});

applyTheme();


/* =========================================================
   STORAGE HELPERS
   ========================================================= */
const $ = id => document.getElementById(id);
const fmt = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const nowISO = ()=> new Date().toISOString();

function loadPerfil(){ return JSON.parse(localStorage.getItem('perfilMotorista') || '{}'); }
function savePerfil(p){ localStorage.setItem('perfilMotorista', JSON.stringify(p)); }

function loadManuts(){ return JSON.parse(localStorage.getItem('manutencoes') || '[]'); }
function saveManuts(a){ localStorage.setItem('manutencoes', JSON.stringify(a)); }

function loadHist(){ return JSON.parse(localStorage.getItem('manutHistorico') || '[]'); }
function saveHist(a){ localStorage.setItem('manutHistorico', JSON.stringify(a)); }


/* =========================================================
   C√ÅLCULOS DE MANUTEN√á√ÉO
   ========================================================= */
function calcularProximas(m, kmAtual){
    m.kmProxima = Number(m.kmUltimaTroca) + Number(m.intervaloKm);
    m.kmRestante = m.kmProxima - kmAtual;
    m.valorPorKm = (Number(m.custoEstimado)||0) / (Number(m.intervaloKm)||1);
    return m;
}

function colorFromKmRestante(km){
    if(km <= 800) return 'statusRed';
    if(km <= 2000) return 'statusWarn';
    return 'statusGreen';
}


/* =========================================================
   RENDERIZA√á√ÉO DO PERFIL
   ========================================================= */
function renderPerfil(){
    const p = loadPerfil();
    $('perfilNome').value = p.nome || "";
    $('perfilMarca').value = p.carro || "";
    $('perfilModelo').value = p.modelo || "";
    $('perfilAno').value = p.ano || "";
    $('perfilPlaca').value = p.placa || "";
    $('kmAtual').value = p.kmAtual || "";
}


/* =========================================================
   RENDERIZA√á√ÉO DAS MANUTEN√á√ïES
   ========================================================= */
function renderManutencoes(){
    const manuts = loadManuts();
    const perfil = loadPerfil();
    const kmAtual = Number(perfil.kmAtual || 0);

    manuts.forEach(m => calcularProximas(m, kmAtual));
    manuts.sort((a,b) => a.kmRestante - b.kmRestante);
    saveManuts(manuts);

    const box = $('listaManutencoes');
    box.innerHTML = "";

    if(manuts.length === 0){
        box.innerHTML = `<div class="smallNote">Nenhuma manuten√ß√£o cadastrada.</div>`;
        return;
    }

    manuts.forEach(m => {
        const div = document.createElement("div");
        div.className = "listItem";

        const statusClass = colorFromKmRestante(m.kmRestante);
        const txt = m.kmRestante < 0 ? `${Math.abs(m.kmRestante)} km atrasado` : `${m.kmRestante} km restantes`;

        div.innerHTML = `
            <div style="flex:1;">
                <div style="font-weight:700; font-size:15px;">${escape(m.nome)}</div>
                <div class="smallNote">√öltima troca: ${m.kmUltimaTroca} km ‚Ä¢ Pr√≥xima: ${m.kmProxima} km</div>
                <div class="smallNote">Custo estimado: ${fmt(m.custoEstimado)}</div>
                ${m.obs ? `<div class="smallNote">Obs: ${escape(m.obs)}</div>` : ""}
            </div>

            <div style="text-align:right;">
                <div class="badge ${statusClass}">${txt}</div>

                <div style="margin-top:10px; display:flex; flex-direction:column; gap:6px;">
                    <button class="btnGhost" style="font-size:12px;" onclick="editarManut(${m.id})">Editar</button>
                    <button class="btnGhost" style="font-size:12px;" onclick="removerManut(${m.id})">Remover</button>
                    <button class="btn" style="font-size:12px;" onclick="marcarRealizada(${m.id})">Marcar Realizada</button>
                </div>
            </div>
        `;

        box.appendChild(div);
    });
}


/* =========================================================
   RENDERIZA√á√ÉO DO HIST√ìRICO
   ========================================================= */
function renderHistorico(){
    const hist = loadHist();
    const tbody = document.querySelector("#histTable tbody");
    tbody.innerHTML = "";

    if(hist.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" class="smallNote">Nenhum registro ainda.</td></tr>`;
        return;
    }

    hist.slice().reverse().forEach(h => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${new Date(h.data).toLocaleString()}</td>
            <td>${escape(h.nome)}</td>
            <td>${h.kmTroca}</td>
            <td>${fmt(h.custoPago)}</td>
            <td>${escape(h.obs||"")}</td>
        `;
        tbody.appendChild(tr);
    });
}


/* =========================================================
   A√á√ïES
   ========================================================= */
function salvarPerfil(){
    const p = loadPerfil();
    p.nome = $('perfilNome').value.trim();
    p.carro = $('perfilMarca').value.trim();
    p.modelo = $('perfilModelo').value.trim();
    p.ano = $('perfilAno').value.trim();
    p.placa = $('perfilPlaca').value.trim();

    const kmNovo = Number($('kmAtual').value);
    if(kmNovo){ p.kmAtual = kmNovo; }

    savePerfil(p);

    const manuts = loadManuts();
    manuts.forEach(m => calcularProximas(m, kmNovo));
    saveManuts(manuts);

    renderManutencoes();
    alert("Dados salvos e manuten√ß√µes recalculadas!");
}

function limparPerfil(){
    renderPerfil();
    renderManutencoes();
    renderHistorico();
}

function adicionarManut(){
    const nome = $('mNome').value.trim();
    const kmUltima = Number($('mKmUltima').value);
    const intervalo = Number($('mIntervalo').value);
    const custo = Number($('mCusto').value);
    const obs = $('mObs').value.trim();

    if(!nome || !kmUltima || !intervalo){
        alert("Preencha nome, km da √∫ltima troca e intervalo.");
        return;
    }

    const perfil = loadPerfil();
    const kmAtual = Number(perfil.kmAtual || 0);

    const m = {
        id: Date.now(),
        nome,
        kmUltimaTroca: kmUltima,
        intervaloKm: intervalo,
        custoEstimado: custo,
        obs,
        criadoEm: nowISO()
    };

    calcularProximas(m, kmAtual);

    const manuts = loadManuts();
    manuts.push(m);
    saveManuts(manuts);

    renderManutencoes();
    limparFormManut();
}

function editarManut(id){
    const manuts = loadManuts();
    const m = manuts.find(x => x.id === id);
    if(!m) return;

    $('mNome').value = m.nome;
    $('mKmUltima').value = m.kmUltimaTroca;
    $('mIntervalo').value = m.intervaloKm;
    $('mCusto').value = m.custoEstimado;
    $('mObs').value = m.obs;

    removerManut(id);
    window.scrollTo({top:0, behavior:"smooth"});
}

function removerManut(id){
    if(!confirm("Deseja remover esta manuten√ß√£o?")) return;
    const manuts = loadManuts().filter(m => m.id !== id);
    saveManuts(manuts);
    renderManutencoes();
}

function marcarRealizada(id){
    const manuts = loadManuts();
    const m = manuts.find(x => x.id === id);
    if(!m) return;

    const perfil = loadPerfil();
    const kmAtual = Number(perfil.kmAtual || 0);

    const kmTroca = Number(prompt("KM da troca:", kmAtual));
    if(!kmTroca) return;

    const valor = Number(prompt("Valor pago:", m.custoEstimado)) || 0;
    const obs = prompt("Obs:", "") || "";

    const hist = loadHist();
    hist.push({
        id:Date.now(),
        nome:m.nome,
        kmTroca,
        custoPago:valor,
        data:nowISO(),
        obs
    });
    saveHist(hist);

    m.kmUltimaTroca = kmTroca;
    calcularProximas(m, kmAtual);
    saveManuts(manuts);

    if(kmTroca > kmAtual){
        perfil.kmAtual = kmTroca;
        savePerfil(perfil);
        renderPerfil();
    }

    renderManutencoes();
    renderHistorico();
    alert("Manuten√ß√£o registrada!");
}


/* =========================================================
   EXPORTA√á√ÉO (WHATSAPP / PDF)
   ========================================================= */
function exportWhats(){
    const p = loadPerfil();
    const manuts = loadManuts().sort((a,b)=>a.kmRestante-b.kmRestante);

    let msg = `Relat√≥rio de Manuten√ß√£o (${new Date().toLocaleDateString()})\n\n`;
    msg += `Ve√≠culo: ${p.carro||""} ${p.modelo||""} (${p.ano||""})\nPlaca: ${p.placa||""}\nKM Atual: ${p.kmAtual||0}\n\n`;

    manuts.forEach(m => {
        msg += `‚Ä¢ ${m.nome}: Pr√≥xima ${m.kmProxima} km (${m.kmRestante} km restantes)\n`;
    });

    window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
}

async function exportPdf(){
    const el = document.querySelector(".container");
    const canvas = await html2canvas(el,{scale:1.6});
    const img = canvas.toDataURL("image/png");
    const pdf = new jspdf.jsPDF("p","mm","a4");

    const w = pdf.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;

    pdf.addImage(img,"PNG",0,0,w,h);
    pdf.save("manutencao.pdf");
}


/* =========================================================
   UTIL
   ========================================================= */
function escape(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function limparFormManut(){
    $('mNome').value = "";
    $('mKmUltima').value = "";
    $('mIntervalo').value = "";
    $('mCusto').value = "";
    $('mObs').value = "";
}

/* =========================================================
   BOOT
   ========================================================= */
(function boot(){
    renderPerfil();
    renderManutencoes();
    renderHistorico();
})();
</script>

</body>
</html>
