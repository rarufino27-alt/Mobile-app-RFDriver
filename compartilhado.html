<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Central de SolicitaÃ§Ãµes â€“ RF DRIVER</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="./theme/theme.css">

<style>
.page{
  min-height:100vh;
  padding:20px;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:500px;
  display:flex;
  flex-direction:column;
  gap:18px;
}

.header{
  padding:20px;
  border-radius:18px;
  background:linear-gradient(180deg,var(--card),#0b2238);
  color:#ffffff;
  text-align:center;
}

.header h2{
  color:#ffffff !important;
}

/* CARD PREMIUM */
.card{
  background:#ffffff;
  padding:18px;
  border-radius:22px;
  box-shadow:0 12px 28px rgba(0,0,0,.08);
  transition:all .25s ease;
  animation:fadeUp .35s ease;
}

.card:hover{
  transform:translateY(-3px);
  box-shadow:0 16px 36px rgba(0,0,0,.12);
}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

/* TOPO DO CARD */
.card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.card-header strong{
  font-size:1rem;
}

/* BADGE STATUS */
.status{
  font-size:.7rem;
  padding:6px 10px;
  border-radius:20px;
  font-weight:700;
}

.status-aberto{
  background:linear-gradient(145deg,#facc15,#eab308);
  color:#000;
}

/* TOTAL PREMIUM */
.total-box{
  margin-top:14px;
  padding:14px;
  border-radius:18px;
  background:linear-gradient(145deg,var(--gold-light),var(--gold));
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:800;
  color:#0b1b2b;
}

/* DETALHAMENTO */
.detalhes-box{
  margin-top:14px;
  padding:14px;
  background:#f8fafc;
  border-radius:16px;
  font-size:.85rem;
}

.detalhe-item{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px solid #e5e7eb;
}

.detalhe-item:last-child{
  border-bottom:none;
}

/* BOTÃ•ES */
.btn{
  margin-top:10px;
  padding:12px;
  border:none;
  border-radius:14px;
  font-weight:700;
  cursor:pointer;
  transition:.2s;
}

.btn-aceitar{
  background:#22c55e;
  color:#ffffff;
}

.btn-aceitar:hover{
  background:#16a34a;
}

.btn-cancelar{
  background:#ef4444;
  color:#ffffff;
}

.btn-cancelar:hover{
  background:#dc2626;
}

.card.fade-out{
  opacity:0;
  transform:translateY(-10px);
  transition:all .3s ease;
}

.base-box{
  margin-top:14px;
  padding:12px;
  background:#eef2ff;
  border-radius:14px;
  font-size:.85rem;
}

.adicionais-box{
  margin-top:10px;
  padding:12px;
  background:#f8fafc;
  border-radius:14px;
  font-size:.85rem;
}
</style>
</head>

<body>

<div class="page">
<div class="container">

<div class="header">
  <h2>Central de SolicitaÃ§Ãµes</h2>
</div>

<div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
  
  <div id="contadorSolicitacoes" style="font-weight:700;"></div>

  <label style="font-size:.85rem;display:flex;align-items:center;gap:6px;">
    <input type="checkbox" id="filtroAbertas" checked>
    Somente abertas
  </label>

</div>

<div id="listaSolicitacoes"></div>

</div>
</div>

<script src="core/global.js"></script>

<script>
const STORAGE_SOLICITACOES = "rf_driver_solicitacoes";
const STORAGE_HISTORICO = "rf_driver_historico";

function getSolicitacoes(){
  return JSON.parse(localStorage.getItem(STORAGE_SOLICITACOES) || "[]");
}

function setSolicitacoes(arr){
  localStorage.setItem(STORAGE_SOLICITACOES, JSON.stringify(arr));
}

function getHistorico(){
  return JSON.parse(localStorage.getItem(STORAGE_HISTORICO) || "[]");
}

function setHistorico(arr){
  localStorage.setItem(STORAGE_HISTORICO, JSON.stringify(arr));
}

// ==========================
// CRIAR NOVA SOLICITAÃ‡ÃƒO
// ==========================
function criarSolicitacao(){

  const origem = App.get("origem");
  const destino = App.get("destino");
  const total = App.get("total");
  const pagamento = App.get("formaPagamento");
  const valorBase = Number(App.get("valorBase") || 0);
  const config = App.get("taxasConfig") || {};

  if(!origem || !destino || !total) return;

  let detalhes = [];

  detalhes.push({ nome:"Viagem base", valor: valorBase });

  if(config.tipoViagem === "bate_volta")
    detalhes.push({ nome:"Bate e volta", valor: valorBase });

  if(config.tipoViagem === "ida_volta")
    detalhes.push({ nome:"Ida e volta", valor: valorBase });

  if(config.tipoViagem === "ida_volta_espera")
    detalhes.push({ nome:"Ida e volta + espera", valor: valorBase + (valorBase*0.10) });

  if(config.desvioSimples)
    detalhes.push({ nome:"Desvio rÃ¡pido", valor: 5 });

  if(config.voltaPraia)
    detalhes.push({ nome:"Volta das praias", valor: 10 });

  if(config.taxaFeira)
    detalhes.push({ nome:"Taxa de feira", valor: 5 });

  if(config.veiculo6)
    detalhes.push({ nome:"VeÃ­culo 6 lugares (50%)", valor: valorBase*0.5 });

  if(config.taxaNoturna)
    detalhes.push({ nome:"Adicional noturno", valor: "Calculado no total" });

  if(Number(config.animal) > 0)
    detalhes.push({ nome:"Transporte animal", valor: Number(config.animal) });

  if(Number(config.minutosEspera) >= 5){
    const min = Number(config.minutosEspera);
    const acres = 3 + ((min-5)*0.60);
    detalhes.push({ nome:`Tempo de espera (${min} min)`, valor: acres });
  }

  const nova = {
    id: Date.now(),
    origem,
    destino,
    total,
    pagamento,
    detalhes,
    status: "aberto",
    criadoEm: new Date().toLocaleString("pt-BR")
  };

  const lista = getSolicitacoes();
  lista.unshift(nova);
  setSolicitacoes(lista);
}

// ==========================
// HISTÃ“RICO
// ==========================
function adicionarHistorico(corrida){

  let historico = getHistorico();

  historico.unshift({
    ...corrida,
    status: "realizada",
    finalizadaEm: new Date().toLocaleString("pt-BR")
  });

  if(historico.length > 25){
    historico = historico.slice(0,25);
  }

  setHistorico(historico);
}

// ==========================
// CANCELAR
// ==========================
function cancelar(id){

  const confirmar = confirm("Deseja realmente cancelar esta solicitaÃ§Ã£o?");
  if(!confirmar) return;

  let lista = getSolicitacoes();
  lista = lista.filter(s => s.id !== id);

  setSolicitacoes(lista);
  render();
}

// ==========================
// ACEITAR
// ==========================
function aceitar(id){

  const card = document.getElementById("card-"+id);
  if(card){
    card.classList.add("fade-out");
  }

  setTimeout(()=>{

    let lista = getSolicitacoes();
    const index = lista.findIndex(s=>s.id === id);

    if(index === -1) return;

    const corrida = lista[index];

    lista.splice(index,1);
    setSolicitacoes(lista);

    adicionarHistorico(corrida);

    render();

  },300);
}

// ==========================
// RENDERIZAR
// ==========================
function render(){

  const filtroAbertas = document.getElementById("filtroAbertas").checked;
  let lista = getSolicitacoes();

  if(filtroAbertas){
    lista = lista.filter(s => s.status === "aberto");
  }

  const container = document.getElementById("listaSolicitacoes");
  const contador = document.getElementById("contadorSolicitacoes");

  contador.innerText = `SolicitaÃ§Ãµes: ${lista.length}`;

  if(lista.length === 0){
    container.innerHTML = "<div class='card'>Nenhuma solicitaÃ§Ã£o aberta.</div>";
    return;
  }

  container.innerHTML = lista.map(s=>{

    const base = s.detalhes.filter(d=>d.nome === "Viagem base");
    const adicionais = s.detalhes.filter(d=>d.nome !== "Viagem base");

    return `
      <div class="card" id="card-${s.id}">

        <div class="card-header">
          <strong>${s.origem} â†’ ${s.destino}</strong>
          <span class="status status-aberto">AGUARDANDO</span>
        </div>

        <small>${s.criadoEm}</small>

        <div class="total-box">
          <span>ðŸ’° Total</span>
          <span>R$ ${Number(s.total).toFixed(2)}</span>
        </div>

        <div style="margin-top:8px;font-size:.85rem;">
          ðŸ’³ ${s.pagamento}
        </div>

        ${base.length ? `
          <div class="base-box">
            <strong>Base</strong><br>
            ${base.map(d=>`
              <div class="detalhe-item">
                <span>${d.nome}</span>
                <strong>R$ ${Number(d.valor).toFixed(2)}</strong>
              </div>
            `).join("")}
          </div>
        ` : ""}

        ${adicionais.length ? `
          <div class="adicionais-box">
            <strong>Adicionais</strong><br>
            ${adicionais.map(d=>`
              <div class="detalhe-item">
                <span>${d.nome}</span>
                <strong>
                  ${
                    typeof d.valor === "number"
                    ? "R$ " + d.valor.toFixed(2)
                    : d.valor
                  }
                </strong>
              </div>
            `).join("")}
          </div>
        ` : ""}

        <button class="btn btn-aceitar" onclick="aceitar(${s.id})">
          Aceitar Corrida
        </button>

        <button class="btn btn-cancelar" onclick="cancelar(${s.id})">
          Cancelar SolicitaÃ§Ã£o
        </button>

      </div>
    `;
  }).join("");
}

// ==========================
// INICIALIZAÃ‡ÃƒO
// ==========================
criarSolicitacao();
render();

document.getElementById("filtroAbertas")
  .addEventListener("change", render);
</script>

</body>
</html>
