<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>RF – Selecionar viagem</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="core/datamanager.js"></script>
<script src="core/dinamico.js"></script>
<script src="core/taxas.js"></script>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
}

body{
  background:#000;
  height:100vh;
  overflow:hidden;
  color:#fff;
}

/* MAPA FAKE */
.map{
  position:absolute;
  inset:0;
  background:#111;
  opacity:.6;
}

/* TOP ROTA */
.rota-top{
  position:absolute;
  top:20px;
  left:20px;
  right:20px;
  background:#fff;
  color:#000;
  border-radius:18px;
  padding:14px;
  font-size:.85rem;
}

.rota-item{
  display:flex;
  justify-content:space-between;
}

.rota-item span:first-child{
  color:#777;
}

/* BOTTOM SHEET */
.sheet{
  position:absolute;
  bottom:0;
  left:0;
  right:0;
  height:60%;
  background:#fff;
  color:#000;
  border-top-left-radius:25px;
  border-top-right-radius:25px;
  display:flex;
  flex-direction:column;
  box-shadow:0 -10px 30px rgba(0,0,0,.4);
}

.handle{
  width:40px;
  height:5px;
  background:#ddd;
  border-radius:10px;
  margin:10px auto;
}

.content{
  flex:1;
  overflow-y:auto;
  padding:10px 20px;
}

/* TITULO */
.titulo{
  font-weight:700;
  font-size:1rem;
  margin-bottom:10px;
}

/* CATEGORIA */
.categoria{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 0;
  border-bottom:1px solid #eee;
  cursor:pointer;
  transition:.2s;
}

.categoria.ativa{
  font-weight:600;
}

.cat-info{
  display:flex;
  flex-direction:column;
}

.cat-nome{
  font-size:.95rem;
}

.cat-desc{
  font-size:.75rem;
  color:#777;
}

.preco{
  text-align:right;
}

.preco-antigo{
  font-size:.7rem;
  text-decoration:line-through;
  color:#999;
}

.preco-dinamico{
  font-size:.95rem;
  font-weight:700;
  color:#facc15;
}

/* PAGAMENTO */
.pagamentos{
  margin-top:15px;
}

.pag-item{
  padding:12px 0;
  border-bottom:1px solid #eee;
  cursor:pointer;
}

.pag-item.ativo{
  font-weight:600;
}

/* BOTTOM BAR */
.bottom-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 20px;
  border-top:1px solid #eee;
}

.valor-total{
  font-size:1.4rem;
  font-weight:700;
}

button{
  padding:12px 24px;
  border:none;
  border-radius:30px;
  background:#facc15;
  font-weight:700;
  font-size:1rem;
  cursor:pointer;
}
</style>
</head>
<body>

<div class="map"></div>

<div class="rota-top" id="rotaBox"></div>

<div class="sheet">
  <div class="handle"></div>

  <div class="content">

    <div class="titulo">Categoria de viagem</div>
    <div id="categorias"></div>

    <div class="titulo" style="margin-top:15px;">Forma de pagamento</div>
    <div class="pagamentos" id="pagamentos"></div>

  </div>

  <div class="bottom-bar">
    <div class="valor-total" id="valorTotal">R$ 0,00</div>
    <button onclick="solicitar()">Solicitar</button>
  </div>
</div>

<script>

const corrida = JSON.parse(localStorage.getItem("rf_corrida_temp"));
if(!corrida) window.location.href = "viagem.html";

const { origem, parada, destino, valor } = corrida;

/* ================= ROTA TOPO ================= */

let rotaHTML = `
<div class="rota-item"><span>Origem</span><span>${origem}</span></div>
`;

if(parada){
  rotaHTML += `<div class="rota-item"><span>Parada</span><span>${parada}</span></div>`;
}

rotaHTML += `
<div class="rota-item"><span>Destino</span><span>${destino}</span></div>
`;

document.getElementById("rotaBox").innerHTML = rotaHTML;

/* ================= TAXA NOTURNA ================= */

function aplicarNoturno(valorBase){

  const agora = new Date();
  const hora = agora.getHours();
  const minuto = agora.getMinutes();

  const horario = hora + (minuto/60);

  if(horario >= 22.5 || horario <= 5){
    return valorBase + Taxas.noturno.valorFixo;
  }

  return valorBase;
}

/* ================= CATEGORIAS ================= */

const categoriasData = [
  { nome:"Driver", desc:"Mais econômico", mult:1.0 },
  { nome:"Driver Plus", desc:"Chega mais rápido", mult:1.15 },
  { nome:"Driver Comfort", desc:"Mais conforto", mult:1.25 },
  { nome:"Driver 6 Lugares", desc:"Ideal para grupos", mult:1.5 }
];

let categoriaSelecionada = 0;
let pagamentoSelecionado = "Dinheiro";

function renderCategorias(){

  const box = document.getElementById("categorias");
  box.innerHTML = "";

  categoriasData.forEach((cat,index)=>{

    const card = document.createElement("div");
    card.className = "categoria";
    if(index===0) card.classList.add("ativa");

    const base = valor * cat.mult;
    const noturno = aplicarNoturno(base);

    const dinamicoAtivo = Dinamico.ativo;
    const dinamicoMult = Dinamico.multiplicador;

    const valorFinal = dinamicoAtivo ? noturno * dinamicoMult : noturno;

    let precoHTML = "";

    if(dinamicoAtivo){
      precoHTML = `
        <div class="preco-antigo">R$ ${noturno.toFixed(2)}</div>
        <div class="preco-dinamico">⚡ R$ ${valorFinal.toFixed(2)}</div>
      `;
    }else{
      precoHTML = `<div class="preco-dinamico">R$ ${valorFinal.toFixed(2)}</div>`;
    }

    card.innerHTML = `
      <div class="cat-info">
        <div class="cat-nome">${cat.nome}</div>
        <div class="cat-desc">${cat.desc}</div>
      </div>
      <div class="preco">${precoHTML}</div>
    `;

    card.onclick = ()=>{
      document.querySelectorAll(".categoria").forEach(c=>c.classList.remove("ativa"));
      card.classList.add("ativa");
      categoriaSelecionada = index;
      atualizarTotal();
    };

    box.appendChild(card);
  });

  atualizarTotal();
}

/* ================= PAGAMENTO ================= */

function renderPagamentos(){

  const pagamentos = ["Dinheiro","Pix","Cartão"];
  const box = document.getElementById("pagamentos");

  pagamentos.forEach(p=>{
    const div = document.createElement("div");
    div.className = "pag-item";
    if(p==="Dinheiro") div.classList.add("ativo");
    div.innerText = p;

    div.onclick = ()=>{
      document.querySelectorAll(".pag-item").forEach(i=>i.classList.remove("ativo"));
      div.classList.add("ativo");
      pagamentoSelecionado = p;
    };

    box.appendChild(div);
  });
}

/* ================= TOTAL ================= */

function atualizarTotal(){

  const cat = categoriasData[categoriaSelecionada];

  let base = valor * cat.mult;
  base = aplicarNoturno(base);

  let total = Dinamico.ativo ? base * Dinamico.multiplicador : base;

  document.getElementById("valorTotal").innerText =
    "R$ " + total.toFixed(2);

  localStorage.setItem("rf_categoria", cat.nome);
  localStorage.setItem("rf_pagamento", pagamentoSelecionado);
  localStorage.setItem("rf_valor_final", total);
}

/* ================= AÇÃO ================= */

function solicitar(){
  window.location.href = "resumo.html";
}

renderCategorias();
renderPagamentos();

</script>

</body>
</html>