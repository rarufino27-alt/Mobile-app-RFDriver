<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Central de SolicitaÃ§Ãµes â€“ RF DRIVER</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="./theme/theme.css">

<style>
.page{
  min-height:100vh;
  padding:20px;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:500px;
  display:flex;
  flex-direction:column;
  gap:18px;
}

.header{
  padding:20px;
  border-radius:18px;
  background:linear-gradient(180deg,var(--card),#0b2238);
  color:#fff;
  text-align:center;
}

  .header h2{
  color:#ffffff !important;
}

.card{
  background:#fff;
  padding:16px;
  border-radius:18px;
  box-shadow:0 8px 22px rgba(0,0,0,.08);
}

.status{
  font-size:.75rem;
  padding:4px 8px;
  border-radius:12px;
  font-weight:700;
}

.status-aberto{
  background:#facc15;
  color:#000;
}

.status-atendimento{
  background:#22c55e;
  color:#fff;
}

.btn{
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
}

.btn-aceitar{
  background:#22c55e;
  color:#fff;
}

  .detalhes-box{
  margin-top:12px;
  padding:12px;
  background:#f8fafc;
  border-radius:14px;
  font-size:.85rem;
}

.detalhe-item{
  display:flex;
  justify-content:space-between;
  padding:4px 0;
  border-bottom:1px solid #e5e7eb;
}

.detalhe-item:last-child{
  border-bottom:none;
}
</style>
</head>

<body>

<div class="page">
<div class="container">

<div class="header">
  <h2>Central de SolicitaÃ§Ãµes</h2>
</div>

<div id="listaSolicitacoes"></div>

</div>
</div>

<script src="core/global.js"></script>

<script>
const STORAGE_SOLICITACOES = "rf_driver_solicitacoes";
const STORAGE_HISTORICO = "rf_driver_historico";

function getSolicitacoes(){
  return JSON.parse(localStorage.getItem(STORAGE_SOLICITACOES) || "[]");
}

function setSolicitacoes(arr){
  localStorage.setItem(STORAGE_SOLICITACOES, JSON.stringify(arr));
}

function getHistorico(){
  return JSON.parse(localStorage.getItem(STORAGE_HISTORICO) || "[]");
}

function setHistorico(arr){
  localStorage.setItem(STORAGE_HISTORICO, JSON.stringify(arr));
}

// ==========================
// CRIAR NOVA SOLICITAÃ‡ÃƒO
// ==========================
function criarSolicitacao(){

  const origem = App.get("origem");
  const destino = App.get("destino");
  const total = App.get("total");
  const pagamento = App.get("formaPagamento");
  const valorBase = Number(App.get("valorBase") || 0);
  const config = App.get("taxasConfig") || {};

  if(!origem || !destino || !total) return;

  let detalhes = [];

  // Viagem base
  detalhes.push({ nome:"Viagem base", valor: valorBase });

  // Tipo de viagem
  if(config.tipoViagem === "bate_volta"){
    detalhes.push({ nome:"Bate e volta", valor: valorBase });
  }

  if(config.tipoViagem === "ida_volta"){
    detalhes.push({ nome:"Ida e volta", valor: valorBase });
  }

  if(config.tipoViagem === "ida_volta_espera"){
    detalhes.push({ nome:"Ida e volta + espera", valor: valorBase + (valorBase*0.10) });
  }

  if(config.desvioSimples)
    detalhes.push({ nome:"Desvio rÃ¡pido", valor: 5 });

  if(config.voltaPraia)
    detalhes.push({ nome:"Volta das praias", valor: 10 });

  if(config.taxaFeira)
    detalhes.push({ nome:"Taxa de feira", valor: 5 });

  if(config.veiculo6)
    detalhes.push({ nome:"VeÃ­culo 6 lugares (50%)", valor: valorBase*0.5 });

  if(config.taxaNoturna)
    detalhes.push({ nome:"Adicional noturno", valor: "Calculado no total" });

  if(Number(config.animal) > 0)
    detalhes.push({ nome:"Transporte animal", valor: Number(config.animal) });

  if(Number(config.minutosEspera) >= 5){
    const min = Number(config.minutosEspera);
    const acres = 3 + ((min-5)*0.60);
    detalhes.push({ nome:`Tempo de espera (${min} min)`, valor: acres });
  }

  const nova = {
    id: Date.now(),
    origem,
    destino,
    total,
    pagamento,
    detalhes,
    status: "aberto",
    criadoEm: new Date().toLocaleString("pt-BR")
  };

  const lista = getSolicitacoes();
  lista.unshift(nova);
  setSolicitacoes(lista);
}

// ==========================
// ADICIONAR AO HISTÃ“RICO
// ==========================
function adicionarHistorico(corrida){

  let historico = getHistorico();

  historico.unshift({
    ...corrida,
    status: "realizada",
    finalizadaEm: new Date().toLocaleString("pt-BR")
  });

  if(historico.length > 25){
    historico = historico.slice(0,25);
  }

  setHistorico(historico);
}

// ==========================
// CANCELAR
// ==========================
function cancelar(id){

  const confirmar = confirm("Deseja realmente cancelar esta solicitaÃ§Ã£o?");
  if(!confirmar) return;

  let lista = getSolicitacoes();
  lista = lista.filter(s => s.id !== id);

  setSolicitacoes(lista);
  render();
}

// ==========================
// ACEITAR
// ==========================
function aceitar(id){

  let lista = getSolicitacoes();
  const index = lista.findIndex(s=>s.id === id);

  if(index === -1) return;

  const corrida = lista[index];

  // Remove da central
  lista.splice(index,1);
  setSolicitacoes(lista);

  // Envia para histÃ³rico
  adicionarHistorico(corrida);

  render();
}

// ==========================
// RENDERIZAR
// ==========================
function render(){

  const lista = getSolicitacoes();
  const container = document.getElementById("listaSolicitacoes");

  if(lista.length === 0){
    container.innerHTML = "<div class='card'>Nenhuma solicitaÃ§Ã£o aberta.</div>";
    return;
  }

  container.innerHTML = lista.map(s=>`
    <div class="card">
      <strong>${s.origem} â†’ ${s.destino}</strong><br>
      <small>${s.criadoEm}</small><br><br>

      ðŸ’° <strong>R$ ${Number(s.total).toFixed(2)}</strong><br>
      ðŸ’³ ${s.pagamento}<br>

${s.detalhes && s.detalhes.length ? `
  <div class="detalhes-box">
    ${s.detalhes.map(d=>`
      <div class="detalhe-item">
        <span>${d.nome}</span>
        <strong>
          ${
            typeof d.valor === "number"
            ? "R$ " + d.valor.toFixed(2)
            : d.valor
          }
        </strong>
      </div>
    `).join("")}
  </div>
` : ""}

      <span class="status status-aberto">
        AGUARDANDO MOTORISTA
      </span>

      <button class="btn btn-aceitar" onclick="aceitar(${s.id})">
        Aceitar
      </button>

      <button class="btn btn-cancelar" onclick="cancelar(${s.id})" style="background:#ef4444;color:#fff;">
        Cancelar
      </button>
    </div>
  `).join("");
}

// ==========================
// INICIALIZAÃ‡ÃƒO
// ==========================
criarSolicitacao();
render();
</script>

</body>
</html>
